#!/usr/bin/env bash

display_help() {
	echo "Usage: nvim-env [options]"
	echo "Options:"
	echo "  --default      Load default nvim environment"
	echo "  --playground   Load playground nvim environment"
	echo "  --clean-cache  Clean nvim cache"
	echo "  -h, --help     Display this help message"
}

check_command() {
	if ! command -v nvim &>/dev/null; then
		echo "Error: Neovim is not installed. Please install Neovim before using this script."
		exit 1
	fi
}

check_directory() {
	if [ ! -d "$1" ]; then
		echo "Error: $1 does not exist."
		exit 1
	fi
}

check_file() {
	if [ ! -e "$1" ]; then
		echo "Error: $1 does not exist."
		exit 1
	fi
}

confirm_overwrite() {
	read -p "This action will overwrite existing configurations. Continue? (y/n): " answer
	case $answer in
	[yY]) ;;
	[nN]) exit ;;
	*)
		echo "Invalid input. Exiting."
		exit 1
		;;
	esac
}

log() {
	echo "$(date +'%Y-%m-%d %H:%M:%S') - $1"
}

log "Starting nvim-env script"
check_command

while [ "$#" -gt 0 ]; do
	curr=$1
	shift

	case "$curr" in
	"--default")
		log "Loading default nvim environment"

		check_directory ~/.dotfiles/nvim/.config/nvim
		check_directory ~/.local/share/nvim
		check_directory ~/.local/state/nvim
		check_directory ~/.cache/nvim

		# Check if already in default mode
		if [ -e ~/.dotfiles/nvim/.config/nvim.bak.playground ]; then
			echo "Already in default mode. Cancelling operation."
			exit 1
		fi

		confirm_overwrite

		mv ~/.dotfiles/nvim/.config/nvim{,.bak.playground}
		mv ~/.local/share/nvim{,.bak.playground}
		mv ~/.local/state/nvim{,.bak.playground}
		mv ~/.cache/nvim{,.bak.playground}

		mv ~/.dotfiles/nvim/.config/nvim{.bak.default,}
		mv ~/.local/share/nvim{.bak.default,}
		mv ~/.local/state/nvim{.bak.default,}
		mv ~/.cache/nvim{.bak.default,}
		;;
	"--playground")
		log "Loading playground nvim environment"

		check_directory ~/.dotfiles/nvim/.config/nvim
		check_directory ~/.local/share/nvim
		check_directory ~/.local/state/nvim
		check_directory ~/.cache/nvim

		# Check if already in playground mode
		if [ -e ~/.dotfiles/nvim/.config/nvim.bak.default ]; then
			echo "Already in playground mode. Cancelling operation."
			exit 1
		fi

		confirm_overwrite

		mv ~/.dotfiles/nvim/.config/nvim{,.bak.default}
		mv ~/.local/share/nvim{,.bak.default}
		mv ~/.local/state/nvim{,.bak.default}
		mv ~/.cache/nvim{,.bak.default}

		mv ~/.dotfiles/nvim/.config/nvim{.bak.playground,}
		mv ~/.local/share/nvim{.bak.playground,}
		mv ~/.local/state/nvim{.bak.playground,}
		mv ~/.cache/nvim{.bak.playground,}
		echo "Playground loaded"
		;;

	"--clean-cache")
		log "Cleaning nvim cache"
		rm -rf ~/.local/share/nvim
		rm -rf ~/.local/state/nvim
		rm -rf ~/.cache/nvim
		log "Cleaning nvim cache completed"
		;;
	"--help" | "-h")
		display_help
		;;
	*) echo "Unavailable command... $curr" ;;
	esac
done

log "nvim-env script completed"
