#!/usr/bin/env bash
set -euo pipefail

echo "üöÄ Installation de Zsh et Oh My Zsh..."

install_zsh() {
  if [[ "$(uname)" == "Linux" ]]; then
    if command -v apt-get &>/dev/null; then
      sudo apt-get update
      sudo apt-get install -y zsh
    elif command -v dnf &>/dev/null; then
      sudo dnf install -y zsh
    else
      echo "‚ö†Ô∏è Gestionnaire de paquets non support√©, installe zsh/curl/git manuellement"
      exit 1
    fi
  elif [[ "$(uname)" == "Darwin" ]]; then
    if command -v brew &>/dev/null; then
      brew install zsh
    else
      echo "‚ö†Ô∏è Homebrew non trouv√©, installe-le manuellement"
      exit 1
    fi
  else
    echo "‚ùå OS non reconnu: $(uname)"
    exit 1
  fi
}

install_oh_my_zsh() {
  # Supprime Oh My Zsh existant si pr√©sent
  if [[ -d "$HOME/.oh-my-zsh" ]]; then
    echo "üßπ Suppression de l'installation existante d'Oh My Zsh"
    rm -rf "$HOME/.oh-my-zsh"
  fi

  echo "‚¨áÔ∏è T√©l√©chargement et installation d'Oh My Zsh..."
  # Ex√©cute le script d'installation sans interaction
  RUNZSH=no CHSH=no sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
}

install_plugins_and_theme() {
  local zsh_custom="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"

  echo "‚¨áÔ∏è Installation du plugin zsh-autosuggestions..."
  git clone https://github.com/zsh-users/zsh-autosuggestions "$zsh_custom/plugins/zsh-autosuggestions"
}

update_zshrc() {
  echo "‚öôÔ∏è Configuration de ~/.zshrc..."

  # Sauvegarde l'ancien .zshrc s'il existe
  if [[ -f "$HOME/.zshrc" ]]; then
    mv "$HOME/.zshrc" "$HOME/.zshrc.backup.$(date +%Y%m%d_%H%M%S)"
    echo "üõ°Ô∏è Sauvegarde de l'ancien .zshrc dans ~/.zshrc.backup.*"
  fi
}

change_default_shell_to_zsh() {
  local zsh_path
  zsh_path="$(which zsh)"

  if [[ "$SHELL" != "$zsh_path" ]]; then
    echo "üîÑ Changement du shell par d√©faut en zsh ($zsh_path)..."
    if chsh -s "$zsh_path"; then
      echo "‚úÖ Shell par d√©faut chang√© en zsh"
    else
      echo "‚ö†Ô∏è Impossible de changer le shell par d√©faut. Fais-le manuellement avec chsh -s $zsh_path"
    fi
  else
    echo "‚ÑπÔ∏è Zsh est d√©j√† le shell par d√©faut"
  fi
}

main() {
  install_zsh
  install_oh_my_zsh
  install_plugins_and_theme
  update_zshrc
  change_default_shell_to_zsh

  echo
  echo "üéâ Installation termin√©e !"
  echo "üëâ Ouvre un nouveau terminal pour utiliser zsh."
}

main
